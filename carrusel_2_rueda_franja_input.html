<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>carrusel_2_rueda_franja_input</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    background: #f0f4f8;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    position: relative;
  }

  #btnSelect, #btnVaciar {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: white;
  }

  #btnSelect { background: #007bff; margin-bottom: 20px; }
  #btnVaciar { background: #dc3545; position: absolute; top: 20px; right: 20px; }

  .circle-container {
    position: relative;
    width: 600px;
    height: 600px;
    border-radius: 50%;
    margin-bottom: 30px;
  }

  .circle-container img {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 10px;
    object-fit: cover;
    transition: transform 0.3s, z-index 0.3s;
  }

  .circle-container img:hover { transform: scale(1.3); z-index: 20; }

  .franja {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding: 10px;
    width: 90%;
    border-top: 2px solid #ccc;
  }

  .thumb-container { position: relative; display: inline-block; }
  .thumb-container img {
    width: 100px; height: 100px; object-fit: cover;
    border-radius: 8px; cursor: pointer; transition: transform 0.2s;
  }
  .thumb-container img:hover { transform: scale(1.1); border: 2px solid #333; }

  .btnEliminar {
    position: absolute; top: 2px; right: 2px;
    background: rgba(220,50,50,0.9); color: white;
    border: none; border-radius: 50%;
    width: 20px; height: 20px; cursor: pointer;
    font-size: 14px; line-height: 18px; text-align: center; padding: 0;
  }
  .btnEliminar:hover { background: red; }

  #inputFiles { display: none; }
</style>
</head>
<body>

<h2>Carrusel 2</h2>

<button id="btnSelect">Select</button>
<input type="file" id="inputFiles" multiple accept="image/*">
<button id="btnVaciar">Vaciar Carrusel</button>

<div class="circle-container" id="circle"></div>
<div class="franja" id="franja"></div>

<script>
const btnSelect = document.getElementById('btnSelect');
const inputFiles = document.getElementById('inputFiles');
const btnVaciar = document.getElementById('btnVaciar');
const container = document.getElementById('circle');
const franja = document.getElementById('franja');

let images = [];
let rotation = 0;
let speed = 0.01;
let isPaused = false;
let lastCycle = 0;

// --- IndexedDB setup ---
let db;
const request = indexedDB.open("CarruselDB", 1);

request.onupgradeneeded = (event) => {
  db = event.target.result;
  if(!db.objectStoreNames.contains("imagenes")) {
    db.createObjectStore("imagenes", { keyPath: "id", autoIncrement: true });
  }
};

request.onsuccess = (event) => {
  db = event.target.result;
  cargarDesdeDB();
};

request.onerror = (event) => { console.error("IndexedDB error", event); };

// --- Funciones carrusel ---
btnSelect.addEventListener('click', () => inputFiles.click());

function organizarCirculo() {
  const total = images.length;
  const radius = 200;
  images.forEach((img, i) => {
    const angle = (i / total) * 2 * Math.PI + rotation;
    const x = radius * Math.cos(angle) + container.offsetWidth / 2 - img.offsetWidth / 2;
    const y = radius * Math.sin(angle) + container.offsetHeight / 2 - img.offsetHeight / 2;
    img.style.left = `${x}px`;
    img.style.top = `${y}px`;
    const normalizedAngle = (angle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
    img.style.zIndex = Math.floor(Math.cos(normalizedAngle) * 10) + 10;
  });
}

function agregarImagen(src, id=null) {
  // Carrusel
  const img = document.createElement('img');
  img.src = src;
  img.loading = "lazy";
  img.dataset.id = id;
  img.addEventListener('mouseenter', () => isPaused = true);
  img.addEventListener('mouseleave', () => isPaused = false);

  container.appendChild(img);
  images.push(img);
  organizarCirculo();

  // Franja
  const thumbContainer = document.createElement('div');
  thumbContainer.className = 'thumb-container';

  const thumb = document.createElement('img');
  thumb.src = src;
  thumb.addEventListener("click", () => {
    const idx = images.findIndex(i => i.dataset.id == id);
    if (idx >= 0) {
      rotation = -(idx / images.length) * 2 * Math.PI;
      organizarCirculo();
    }
  });

  const btnEliminar = document.createElement('button');
  btnEliminar.className = 'btnEliminar';
  btnEliminar.textContent = '×';
  btnEliminar.onclick = (e) => {
    e.stopPropagation();
    const idx = images.findIndex(i => i.dataset.id == id);
    if(idx >= 0) {
      const imgToRemove = images.splice(idx,1)[0];
      container.removeChild(imgToRemove);
      eliminarImagenDB(id);
    }
    franja.removeChild(thumbContainer);
  };

  thumbContainer.appendChild(thumb);
  thumbContainer.appendChild(btnEliminar);
  franja.appendChild(thumbContainer);
}

// --- DB Functions ---
function guardarImagenDB(src) {
  const transaction = db.transaction(["imagenes"], "readwrite");
  const store = transaction.objectStore("imagenes");
  store.add({ src });
}

function cargarDesdeDB() {
  const transaction = db.transaction(["imagenes"], "readonly");
  const store = transaction.objectStore("imagenes");
  const request = store.getAll();
  request.onsuccess = () => {
    request.result.forEach(item => agregarImagen(item.src, item.id));
  };
}

function eliminarImagenDB(id) {
  const transaction = db.transaction(["imagenes"], "readwrite");
  const store = transaction.objectStore("imagenes");
  store.delete(id);
}

// --- Subir archivos ---
inputFiles.addEventListener('change', (e) => {
  for(let file of e.target.files){
    const reader = new FileReader();
    reader.onload = () => {
      agregarImagen(reader.result);
      guardarImagenDB(reader.result);
    }
    reader.readAsDataURL(file);
  }
});

// --- Vaciar carrusel ---
btnVaciar.addEventListener('click', () => {
  images.forEach(img => container.removeChild(img));
  images = [];
  franja.innerHTML = '';
  const transaction = db.transaction(["imagenes"], "readwrite");
  transaction.objectStore("imagenes").clear();
  rotation = 0; speed = 0.01;
});

// --- Animación ---
container.addEventListener('wheel', e => {
  e.preventDefault();
  speed += e.deltaY * -0.0005;
});

function animar() {
  if(!isPaused){
    rotation += speed;
    const cycles = Math.floor(rotation/(2*Math.PI));
    if(cycles>lastCycle){
      lastCycle = cycles;
      if(images.length>1){
        const first = images.shift();
        images.push(first);
      }
    }
  }
  organizarCirculo();
  requestAnimationFrame(animar);
}
animar();

</script>
</body>
</html>