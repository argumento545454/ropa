<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>carrusel_54_01_r3_voz_cam</title>


<!--1-->
<style>
  body {margin:0; padding:0; height:100vh; width:100vw; display:flex; background:#ddd; overflow:hidden; font-family:Arial,sans-serif;}
  
  /* ===== Men� lateral ===== */
  #menuColDerecha {
    flex:0 0 180px; background:#222; color:#fff; padding:10px; display:flex; flex-direction:column;
  }
  #botonesExtraDerecha { margin-top:auto; display:flex; flex-direction:column; gap:8px; }

  /* ===== T�tulo categor�a ===== */
#nombreCategoriaMenuDerecha {
  position: absolute;
  top: 25px;                /* más arriba */
  left: 25%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;                /* menos separación entre letras o elementos */
  overflow-x: auto;
  white-space: nowrap;
  padding: 6px 20px;        /* antes 20px → rectángulo mucho más pequeño */
  width: 20%;               /* menos ancho */
  max-width: 600px;         /* límite más compacto */
  background: #ffeb3b;
  border-radius: 6px;       /* bordes más pequeños */
  justify-content: center;
  align-items: center;
  z-index: 4;
  font-size: 40px;         /* texto proporcionado */
  /*font-size: 1.2em;          texto proporcionado */
  font-weight: bold;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.2); /* sombra suave */
}


  /* ===== Carrusel principal (ovalado) ===== */
  #carruselAutomatico {
    position:absolute; top:400px; left:50%; transform:translateX(-50%);
    width:80%; max-width:1200px; height:320px;
    perspective:1200px; display:flex; justify-content:center; align-items:center; overflow:visible; z-index:5;
  }
  #carruselAutomatico img {
    position:absolute; width:500px; height:500px; object-fit:cover; border-radius:50%;
    transition:transform 0.3s linear, opacity 0.3s linear; will-change: transform, opacity;
  }

  /* ===== Franja de miniaturas ===== */
  #contenedorCarruselDerecha {
    position:absolute; top:1050px; left:30%; transform:translateX(-50%);
    display:flex; gap:20px; overflow-x:auto; white-space:nowrap; padding:20px;
    width:85%; max-width:600px; scrollbar-width:thin; -webkit-overflow-scrolling:touch;
    background:#ccc; border-radius:12px; justify-content:center; align-items:center; z-index:4;
  }
  #contenedorCarruselDerecha::-webkit-scrollbar { height:8px; }
  #contenedorCarruselDerecha::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.3); border-radius:4px; }
  #contenedorCarruselDerecha { -ms-overflow-style:none; scrollbar-width:none; }

  /* ===== Bot�n Ropa 1 discreto ===== */
  #btnMostrarRopa1 {
    position:fixed; bottom:10px; right:10px;
    background:#ff9800; color:#fff; border:none; border-radius:10px;
    padding:8px 14px; cursor:pointer; z-index:9999; opacity:0.2;
    transition:opacity 0.3s, transform 0.2s; font-size:16px;
  }
</style>



<!--1.2-->
<style>
  /* OCULTAR FRANJA - Botón discreto en la izquierda de la franja */
  #btnToggleFranja {
    position: absolute;
    top: 50%; /* centrado vertical respecto a la franja */
    left: 0;  /* al inicio de la franja */
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    background: #ff9800;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    z-index: 9999;
    opacity: 0.3;
    transition: transform 0.2s, opacity 0.3s;
  }
  #btnToggleFranja:hover {
    transform: translate(-50%, -50%) scale(1.1);
    opacity: 0.7;
  }
</style>

<!--1.3-->
<button id="btnToggleFranja" title="Mostrar/Ocultar franja"></button>

<!--1.4-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnFranja = document.getElementById("btnToggleFranja");
  const franja = document.getElementById("contenedorCarruselDerecha");

  btnFranja.addEventListener("click", () => {
    if (!franja) return;
    const visible = franja.style.display !== "none";
    franja.style.display = visible ? "none" : "flex";
  });
});
</script>

</head>


<!--2-->

<body>

<!--2.1-->
  <!-- Menu lateral -->
  <div id="menuColDerecha">
    <div id="botonesExtraDerecha"></div>
  </div>

<!--2.2-->

  <!-- Zona principal -->
  <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <h2 id="nombreCategoriaMenuDerecha">T�tulo categor�a</h2>
    <div id="carruselAutomatico"></div>
    <div id="contenedorCarruselDerecha"></div>
  </div>


<!--3-->
<script>
document.addEventListener("DOMContentLoaded", () => {

  // ====== Variables principales ======
  let categoriasIniciales = JSON.parse(localStorage.getItem('categoriasIniciales') || '[]');
  if (categoriasIniciales.length===0){
    categoriasIniciales = [
      {nombre:"Sombreros", imagenes:[]},
      {nombre:"Blusas", imagenes:[]},
      {nombre:"Pantalones", imagenes:[]},
      {nombre:"Zapatos", imagenes:[]},
      {nombre:"Vestidos", imagenes:[]}
    ];
    localStorage.setItem('categoriasIniciales', JSON.stringify(categoriasIniciales));
  }

  let indiceCategoria=0;
  let tiempoMenu=parseInt(localStorage.getItem('tiempoRotacion'))||3000;
  let velocidadCarrusel=parseFloat(localStorage.getItem('velocidadCarrusel'))||1;
  let intervaloCategorias;

  const menuColDerecha = document.getElementById('menuColDerecha');
  const botonesExtraDerecha = document.getElementById('botonesExtraDerecha');
  const nombreCategoriaElem = document.getElementById('nombreCategoriaMenuDerecha');
  const contenedorCarrusel = document.getElementById('contenedorCarruselDerecha');
  const carruselAutomatico = document.getElementById('carruselAutomatico');

  // ====== Men� lateral de categor�as ======
  categoriasIniciales.forEach((cat, idx)=>{
    const btn=document.createElement('button');
    btn.textContent=cat.nombre;
    btn.style.cssText="display:block;width:100%;font-size:20px;margin:5px 0;padding:10px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;";
    btn.addEventListener('click',()=>{ indiceCategoria=idx; mostrarCategoria(); });
    menuColDerecha.insertBefore(btn, botonesExtraDerecha);
  });

  // ====== Botones extra ======
  const btnSubirImg=document.createElement("button");
  btnSubirImg.textContent="Subir img";
  btnSubirImg.style.cssText="padding:6px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:20px;";

  const contTiempo=document.createElement("div");
  contTiempo.style.cssText="display:flex;flex-direction:column;align-items:center;gap:4px;background:#ff9800;border-radius:6px;padding:6px;font-size:18px;";
  const textoTiempo=document.createElement("div");
  textoTiempo.style.cssText="color:#fff;font-weight:bold;";
  const flechaArriba=document.createElement("button");
  const flechaAbajo=document.createElement("button");
  [flechaArriba,flechaAbajo].forEach(b=>{ b.style.cssText="width:100%;border:none;background:#fff;color:#ff9800;font-size:16px;border-radius:4px;cursor:pointer;"; });
  flechaArriba.textContent="?"; flechaAbajo.textContent="?";
  contTiempo.append(flechaArriba,textoTiempo,flechaAbajo);

  const btnVelocidad=document.createElement("button");
  btnVelocidad.textContent="Velocidad";
  btnVelocidad.style.cssText="padding:6px;background:#673ab7;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:20px;";

  botonesExtraDerecha.append(btnSubirImg,contTiempo,btnVelocidad);

  // ====== Subir imagen ======
  btnSubirImg.addEventListener("click",()=>{
    const input=document.createElement("input");
    input.type="file"; input.accept="image/*"; input.multiple=true;
    input.onchange=e=>{
      Array.from(e.target.files).forEach(f=>{
        const fr=new FileReader();
        fr.onload=ev=>{
          categoriasIniciales[indiceCategoria].imagenes.push(ev.target.result);
          localStorage.setItem('categoriasIniciales',JSON.stringify(categoriasIniciales));
          mostrarCategoria();
        };
        fr.readAsDataURL(f);
      });
    };
    input.click();
  });

  // ====== Control tiempo ======
  function reiniciarIntervaloMenu(){
    clearInterval(intervaloCategorias);
    intervaloCategorias=setInterval(()=>{
      indiceCategoria=(indiceCategoria+1)%categoriasIniciales.length;
      mostrarCategoria();
    }, tiempoMenu);
    localStorage.setItem('tiempoRotacion',tiempoMenu);
  }
  flechaArriba.addEventListener("click",()=>{ tiempoMenu=Math.min(tiempoMenu+5000,90000); textoTiempo.textContent=`Tiempo: ${(tiempoMenu/1000).toFixed(1)}s`; reiniciarIntervaloMenu(); });
  flechaAbajo.addEventListener("click",()=>{ tiempoMenu=Math.max(tiempoMenu-5000,5000); textoTiempo.textContent=`Tiempo: ${(tiempoMenu/1000).toFixed(1)}s`; reiniciarIntervaloMenu(); });

  // ====== Control velocidad ======
  btnVelocidad.addEventListener("click",()=>{
    velocidadCarrusel+=0.2; if(velocidadCarrusel>3) velocidadCarrusel=0.4;
    localStorage.setItem('velocidadCarrusel',velocidadCarrusel);
    btnVelocidad.textContent=`Velocidad �${velocidadCarrusel.toFixed(1)}`;
  });

  // ====== Carrusel ovalado ======
  function iniciarCarrusel(){
    carruselAutomatico.innerHTML="";
    const categoria=categoriasIniciales[indiceCategoria];
    if(!categoria || !categoria.imagenes || categoria.imagenes.length===0) return;

    const radioX=Math.max(200,(carruselAutomatico.clientWidth/2)-120);

    const radioY=Math.max(120,(carruselAutomatico.clientHeight/2)-40);

    const imgs=[];
    categoria.imagenes.forEach((url,idx)=>{
      const img=document.createElement("img");
      img.src=url; img.className="imgCarrusel"; img.dataset.index=idx; img._hover=false;
      carruselAutomatico.appendChild(img); imgs.push(img);

      img.addEventListener("mouseenter",()=>{ img._hover=true; window.__ropa3_paused=true; });
      img.addEventListener("mouseleave",()=>{ img._hover=false; window.__ropa3_paused=false; });

      img.addEventListener("click",()=>{
        const arr=categoria.imagenes; const i=parseInt(img.dataset.index,10);
        if(!isNaN(i) && arr[i]){
          const item=arr.splice(i,1)[0]; arr.unshift(item);
          localStorage.setItem('categoriasIniciales',JSON.stringify(categoriasIniciales));
          mostrarCategoria();
        }
      });
    });

    let angulo=0; let ultimo=performance.now(); window.__ropa3_paused=false;
    function animarOval(now){
      const delta=(now-ultimo)/1000; ultimo=now;
      if(!window.__ropa3_paused) angulo+=velocidadCarrusel*60*delta;
      imgs.forEach((el,i)=>{
        const fase=(i*360/imgs.length+angulo)*Math.PI/180;
        const x=Math.cos(fase)*radioX;
        const y=Math.sin(fase)*radioY*0.7;
        const z=Math.sin(fase)*80;
        const baseScale=1+z/400;
        const hoverExtra=el._hover?1.35:1;
        const escalaFinal=baseScale*hoverExtra;
        const op=Math.min(1,Math.max(0.2,0.55+z/200));
        el.style.transform=`translate3d(${x}px,${y}px,${z}px) scale(${escalaFinal})`;
        el.style.opacity=op;
        el.style.zIndex=Math.round(300+z);
        el.dataset.index=i;
      });
      requestAnimationFrame(animarOval);
    }
    ultimo=performance.now(); requestAnimationFrame(animarOval);
  }

  // ====== Mostrar categor�a ======
  function mostrarCategoria(){
    const categoria=categoriasIniciales[indiceCategoria];
    nombreCategoriaElem.textContent=categoria.nombre;

    // Franja miniaturas
    contenedorCarrusel.innerHTML="";
    categoria.imagenes.forEach((imgSrc,idx)=>{
      const wrapper=document.createElement("div"); wrapper.style.cssText="position:relative;width:60px;height:60px;";
      const miniatura=document.createElement("img"); miniatura.src=imgSrc; miniatura.style.cssText="width:100%;height:100%;object-fit:cover;border-radius:8px;cursor:pointer;";
      miniatura.addEventListener("click",()=>{ mostrarCategoria(); });
      const btnEliminar=document.createElement("button"); btnEliminar.textContent="�";
      btnEliminar.style.cssText="position:absolute;top:-6px;right:-6px;width:18px;height:18px;font-size:14px;color:#fff;background:#f44336;border:none;border-radius:50%;cursor:pointer;";
      btnEliminar.addEventListener("click",()=>{ categoria.imagenes.splice(idx,1); localStorage.setItem('categoriasIniciales',JSON.stringify(categoriasIniciales)); mostrarCategoria(); });
      wrapper.append(miniatura,btnEliminar); contenedorCarrusel.appendChild(wrapper);
    });

    iniciarCarrusel();
    textoTiempo.textContent=`Tiempo: ${(tiempoMenu/1000).toFixed(1)}s`;
    btnVelocidad.textContent=`Velocidad Images �${velocidadCarrusel.toFixed(1)}`;
  }

  mostrarCategoria();
  reiniciarIntervaloMenu();



  // ====== Bot�n discreto Ropa1 ======
  const ropa1=document.getElementById("ropa1")||document.querySelector(".ropa1");
  if(ropa1){ ropa1.style.display="none"; ropa1.style.opacity="0"; }
  const btnMostrarRopa1=document.createElement("button"); btnMostrarRopa1.id="btnMostrarRopa1"; btnMostrarRopa1.textContent="?? Ropa 1";
  btnMostrarRopa1.title="Click o Ctrl+Alt+R para mostrar/ocultar Ropa 1";
  btnMostrarRopa1.addEventListener("click",()=>{ 
    if(!ropa1) return;
    const visible=ropa1.style.display!=="none";
    ropa1.style.display=visible?"none":"block";
    ropa1.style.opacity=visible?"0":"1";
  });
  btnMostrarRopa1.addEventListener("mouseenter",()=>{ btnMostrarRopa1.style.opacity="1"; btnMostrarRopa1.style.transform="scale(1.05)"; });
  btnMostrarRopa1.addEventListener("mouseleave",()=>{ btnMostrarRopa1.style.opacity="0.2"; btnMostrarRopa1.style.transform="scale(1)"; });
  document.body.appendChild(btnMostrarRopa1);

  document.addEventListener("keydown",(e)=>{ if(e.ctrlKey && e.altKey && e.key.toLowerCase()==="r"){ btnMostrarRopa1.click(); } });
});
</script>




<!--4-->
<!-- ================= Cámara independiente ================= -->
<!-- Botón cámara y cámara funcional -->
<!-- ================= Cámara independiente ================= -->


<!--4.1-->
<style>
  #btnCamara {
    position: fixed;
    bottom: 80px; 
    right: 20px;
    width: 60px;
    height: 60px;
    background: url('https://cdn-icons-png.flaticon.com/512/2920/2920222.png') no-repeat center center;
    background-size: contain;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 9999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: transform 0.2s, opacity 0.3s;
  }
  #btnCamara:hover { transform: scale(1.1); opacity: 0.9; }

  #videoCamara {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 900px; height: auto; /* video grande para tomar la foto */
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    z-index: 9998;
    display: none;
  }

  #fotoCamara {
    position: fixed;
    top: 20px; left: 50%;
    transform: translateX(-50%);
    width: 300px; height: auto;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 9998;
    display: none;
  }
</style>



<!--5-->
<video id="videoCamara" autoplay></video>
<img id="fotoCamara" alt="Foto tomada"/>
<button id="btnCamara" title="Abrir cámara"></button>


<!--6-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnCamara = document.getElementById('btnCamara');
  const videoCamara = document.getElementById('videoCamara');
  const fotoCamara = document.getElementById('fotoCamara');
  let stream = null;

  btnCamara.addEventListener("click", async () => {
    if(videoCamara.style.display === 'block') {
      // Segundo clic: tomar foto
      const canvas = document.createElement('canvas');
      canvas.width = videoCamara.videoWidth;
      canvas.height = videoCamara.videoHeight;
      canvas.getContext('2d').drawImage(videoCamara, 0, 0);
      fotoCamara.src = canvas.toDataURL('image/png');
      fotoCamara.style.display = 'block';
      videoCamara.style.display = 'none';
      // Detener cámara
      if(stream) stream.getTracks().forEach(track => track.stop());
      stream = null;
    } else {
      // Primer clic: activar cámara
      fotoCamara.style.display = 'none';
      try {
        stream = await navigator.mediaDevices.getUserMedia({video:true});
        videoCamara.srcObject = stream;
        videoCamara.style.display = 'block';
      } catch(err) {
        alert("No se pudo acceder a la cámara: " + err.message);
      }
    }
  });
});
</script>




<!--7-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ropa1Btn = document.getElementById("btnMostrarRopa1");
  const colIzq = document.getElementById("menuColDerecha");
  const zonaPrincipal = colIzq.nextElementSibling; // la zona principal junto a la columna

  ropa1Btn.addEventListener("click", () => {
    if (!colIzq) return;

    const visible = colIzq.style.display !== "none";
    colIzq.style.display = visible ? "none" : "flex";

    // Ajustar flex del contenido principal
    if (zonaPrincipal) zonaPrincipal.style.flex = visible ? "1 1 100%" : "1";
  });
});
</script>







<!--8-->
<!--FRANJA - BOTON MOSTRAR / OCULTAR-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const franja = document.getElementById("contenedorCarruselDerecha");
  const zonaPrincipal = franja.parentNode; // contenedor de franja y carrusel

  if(!franja) return;

  // Crear zona clicable solo si no existe
  if(!document.getElementById("zonaClickFranja")){
    const zonaClick = document.createElement("div");
    zonaClick.id = "zonaClickFranja";
    zonaClick.textContent = "x";    //Franja mostrar/ocultar";
    zonaClick.style.height = "30px";
    zonaClick.style.backgroundColor = "#555";
    zonaClick.style.color = "white";
    zonaClick.style.display = "flex";
    zonaClick.style.alignItems = "center";
    zonaClick.style.justifyContent = "center";
    zonaClick.style.cursor = "pointer";
    zonaClick.style.fontWeight = "bold";
    zonaClick.style.userSelect = "none";
    zonaClick.style.marginBottom = "5px";
    zonaClick.style.borderRadius = "6px";
    zonaClick.style.position = "absolute";
    zonaClick.style.top = (franja.offsetTop - 40) + "px"; // justo arriba de la franja
    zonaClick.style.left = "15%";
    zonaClick.style.transform = "translateX(-50%)";
    zonaClick.style.zIndex = "9999";

    zonaPrincipal.appendChild(zonaClick);

    // Estado visible inicial
    if(!window.__franjaVisible) window.__franjaVisible = true;

    zonaClick.addEventListener("click", ()=>{
      window.__franjaVisible = !window.__franjaVisible;
      franja.style.display = window.__franjaVisible ? "flex" : "none";
    });
  }

  // Aplicar estado inicial
  franja.style.display = window.__franjaVisible ? "flex" : "none";
});
</script>







<!--9-->
<!-- VOICE CAMERA MODULE - pegar antes de </body> -->
<div id="voiceCameraModule" aria-live="polite">
  <style>
    /* contenedor principal (cambie ubicación/size desde aquí) */
    #voiceCameraModule {
      position: fixed;
      right: 20px;           /* puede mover a left/top/bottom */
      bottom: 20px;
      width: 360px;          /* tamaño del panel (ajustable) */
      z-index: 9999;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
      pointer-events: auto;
    }

    /* panel compacto */
    #vc-panel {
      background: rgba(18,18,18,0.85);
      color: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    /* video - estilo adaptable */
    #vc-video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      background: #000;
      display: none; /* visible solo cuando se enciende */
    }

    /* botones mínimos, fácil de reubicar o esconder */
    .vc-controls {
      display:flex;
      gap:8px;
      justify-content: space-between;
      align-items:center;
    }
    .vc-btn {
      flex:1;
      padding:8px 10px;
      border-radius:8px;
      border: none;
      background: #ffffff12;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      backdrop-filter: blur(4px);
    }
    .vc-btn:active { transform: translateY(1px); }

    /* status pequeño */
    #vc-status {
      font-size:12px;
      opacity:0.9;
      text-align:center;
      padding: 2px 4px;
    }

    /* la imagen resultante colocada en centro superior (sobre el body) */
    #vc-captured {
      position: fixed;
      left: 50%;
      top: 12px;                  /* altura desde top, modifique aquí */
      transform: translateX(-50%);
      max-width: 40vw;
      width: 320px;
      border-radius: 8px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.45);
      z-index: 10000;
      display: none;
      background: #fff;
    }

    /* pequeño texto debajo de la miniatura (opcional) */
    #vc-captured + #vc-captured-label {
      position: fixed;
      left: 50%;
      top: calc(12px + 100% + 8px);
      transform: translateX(-50%);
      z-index: 10000;
      color: #111;
      display: none;
      font-size: 13px;
      background: rgba(255,255,255,0.95);
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.2);
    }

    /* esconder controles si desea (apliquelo con JS o CSS) */
    .vc-hidden { display:none !important; }
  </style>

  <div id="vc-panel" role="region" aria-label="Panel cámara por voz">
    <div id="vc-status">Esperando comando de voz: diga "encender cámara"</div>

    <video id="vc-video" autoplay playsinline muted></video>

    <div class="vc-controls">
      <button type="button" class="vc-btn" id="vc-btn-toggle">Encender cámara</button>
      <button type="button" class="vc-btn" id="vc-btn-snap">Tomar foto</button>
    </div>

    <div style="font-size:11px; opacity:0.85; text-align:center;">
      Comandos por voz: <strong>"encender cámara"</strong>, <strong>"tomar foto"</strong>.
    </div>
  </div>

  <img id="vc-captured" alt="Foto tomada por voz" />
  <div id="vc-captured-label">Foto guardada</div>

  <script>
    (function () {
      // Elementos
      const statusEl = document.getElementById('vc-status');
      const videoEl = document.getElementById('vc-video');
      const btnToggle = document.getElementById('vc-btn-toggle');
      const btnSnap = document.getElementById('vc-btn-snap');
      const capturedImg = document.getElementById('vc-captured');
      const capturedLabel = document.getElementById('vc-captured-label');

      let stream = null;
      let recognition = null;
      let isCameraOn = false;

      // Función: actualizar estado visible
      function setStatus(text) {
        statusEl.textContent = text;
      }

      // Función: encender cámara
      async function startCamera() {
        if (isCameraOn) return;
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
          videoEl.srcObject = stream;
          videoEl.style.display = 'block';
          isCameraOn = true;
          setStatus('Cámara encendida. Diga "tomar foto" o presione Tomar foto.');
          btnToggle.textContent = 'Apagar cámara';
        } catch (err) {
          console.error('getUserMedia error:', err);
          setStatus('Error al acceder a la cámara. Compruebe permisos y HTTPS.');
        }
      }

      // Función: apagar cámara
      function stopCamera() {
        if (!stream) return;
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        videoEl.srcObject = null;
        videoEl.style.display = 'none';
        isCameraOn = false;
        setStatus('Cámara apagada. Diga "encender cámara".');
        btnToggle.textContent = 'Encender cámara';
      }

      // Función: capturar foto, mostrar y descargar
      function takePhotoAndDownload() {
        if (!isCameraOn || !videoEl.srcObject) {
          setStatus('Cámara no está encendida.');
          return;
        }
        // crear canvas temporal con resolución del video
        const videoTrack = videoEl.srcObject.getVideoTracks()[0];
        const settings = videoTrack.getSettings ? videoTrack.getSettings() : {};
        const w = settings.width || videoEl.videoWidth || 1280;
        const h = settings.height || videoEl.videoHeight || 720;

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        // dibujar video en canvas (puede ajustar recorte/scale aquí)
        ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

        // convertir a dataURL (jpeg para tamaño más pequeño)
        canvas.toBlob(blob => {
          if (!blob) {
            setStatus('Error al generar la foto.');
            return;
          }

          // Mostrar miniatura (centrada en top)
          const url = URL.createObjectURL(blob);
          capturedImg.onload = () => { URL.revokeObjectURL(url); }; // liberar
          capturedImg.src = url;
          capturedImg.style.display = 'block';
          capturedLabel.style.display = 'block';

          // Forzar descarga con nombre timestamp
          const now = new Date();
          const pad = n => String(n).padStart(2, '0');
          const filename = `foto_voz_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.jpg`;

          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();

          // apagar cámara después de tomar la foto
          stopCamera();

          // ocultar la miniatura después de X segundos si desea (aquí 12s)
          setTimeout(() => {
            capturedImg.style.display = 'none';
            capturedLabel.style.display = 'none';
          }, 12000);

          setStatus(`Foto tomada y descargada como ${filename}`);
        }, 'image/jpeg', 0.92);
      }

      // Botones
      btnToggle.addEventListener('click', () => {
        if (isCameraOn) stopCamera(); else startCamera();
      });
      btnSnap.addEventListener('click', () => takePhotoAndDownload());

      // --- Reconocimiento de voz ---
      function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          setStatus('Reconocimiento de voz no soportado en este navegador.');
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
          setStatus('Escuchando comandos de voz: diga "encender cámara" o "tomar foto".');
        };

        recognition.onerror = (event) => {
          console.warn('SpeechRecognition error', event);
          if (event.error === 'not-allowed' || event.error === 'microphone') {
            setStatus('Permiso de micrófono denegado. Compruebe permisos del navegador.');
          } else {
            setStatus('Error reconocimiento voz: ' + (event.error || 'desconocido'));
          }
        };

        recognition.onend = () => {
          // Reiniciar para seguir escuchando (a menos que el usuario quiera parar)
          // algunos navegadores dejan de escuchar después de un comando, intentamos reanudar
          try { recognition.start(); } catch (e) { /* ignore */ }
        };

        recognition.onresult = (event) => {
          const last = event.results[event.results.length - 1];
          const text = (last[0].transcript || '').trim().toLowerCase();
          console.log('VOICE:', text);
          setStatus('Comando detectado: "' + text + '"');

          // aceptar variantes: con o sin acento, verbos en infinitivo/imperativo
          if (text.includes('encender cámara') || text.includes('encender camara') || text.includes('prender cámara') || text.includes('prender camara')) {
            startCamera();
            return;
          }
          if (text.includes('tomar foto') || text.includes('sacar foto') || text.includes('sacar una foto') || text.includes('tomar una foto')) {
            takePhotoAndDownload();
            return;
          }
          // comandos para apagar explicitamente
          if (text.includes('apagar cámara') || text.includes('apagar camara') || text.includes('cerrar cámara') || text.includes('cerrar camara')) {
            stopCamera();
            return;
          }
        };

        // iniciar reconocimiento (nota: algunos navegadores requieren interacción del usuario para permitir audio)
        try {
          recognition.start();
        } catch (err) {
          console.warn('No se pudo iniciar reconocimiento automáticamente:', err);
        }
      }

      // iniciar reconocimiento al cargar el módulo
      setupSpeechRecognition();

      // Advertencia para el usuario en consola / accesibilidad
      console.log('Voice Camera Module cargado. Use comandos: "encender cámara", "tomar foto".');

      // Exponer funciones para debugging / control externo si quiere
      window.vc = {
        startCamera,
        stopCamera,
        takePhotoAndDownload,
        toggleCamera: () => isCameraOn ? stopCamera() : startCamera(),
        recognitionActive: () => !!recognition
      };

    })();
  </script>
</div>
<!-- FIN VOICE CAMERA MODULE -->



</body>
</html>