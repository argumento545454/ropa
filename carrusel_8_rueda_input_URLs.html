<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>carrusel_8_rueda_input_URLs</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    background: #f0f4f8;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    position: relative;
  }

  button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 16px;
  }

  #btnDemo { background: #28a745; }
  #btnSelect { background: #007bff; }
  #btnVaciar { background: #dc3545; position: absolute; top: 20px; right: 20px; }

  .circle-container {
    position: relative;
    width: 600px;
    height: 600px;
    border-radius: 50%;
    margin-bottom: 30px;
    display: none;
  }

  .circle-container img {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 10px;
    object-fit: cover;
    transition: transform 0.3s, z-index 0.3s;
  }

  .circle-container img:hover { transform: scale(1.3); z-index: 20; }

  .franja {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding: 10px;
    width: 90%;
    border-top: 2px solid #ccc;
    display: none;
  }

  .thumb-container { position: relative; display: inline-block; }
  .thumb-container img {
    width: 100px; height: 100px; object-fit: cover;
    border-radius: 8px; cursor: pointer; transition: transform 0.2s;
  }
  .thumb-container img:hover { transform: scale(1.1); border: 2px solid #333; }

  .btnEliminar {
    position: absolute; top: 2px; right: 2px;
    background: rgba(220,50,50,0.9); color: white;
    border: none; border-radius: 50%;
    width: 20px; height: 20px; cursor: pointer;
    font-size: 14px; line-height: 18px; text-align: center; padding: 0;
  }
  .btnEliminar:hover { background: red; }

  #inputFiles { display: none; }
</style>
</head>
<body>

<h2>Carrusel 8</h2>

<div id="menuInicial">
  <button id="btnDemo">DEMO</button>
  <button id="btnSelect">SELECT</button>
</div>

<input type="file" id="inputFiles" multiple accept="image/*">
<button id="btnVaciar">Vaciar Carrusel</button>

<div class="circle-container" id="circle"></div>
<div class="franja" id="franja"></div>

<script>
const btnDemo = document.getElementById('btnDemo');
const btnSelect = document.getElementById('btnSelect');
const inputFiles = document.getElementById('inputFiles');
const btnVaciar = document.getElementById('btnVaciar');
const container = document.getElementById('circle');
const franja = document.getElementById('franja');
const menuInicial = document.getElementById('menuInicial');

let images = [];
let rotation = 0;
let speed = 0.01;
let isPaused = false;
let lastCycle = 0;

// --- IndexedDB setup ---
let db;
const request = indexedDB.open("CarruselDB", 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains("imagenes")) {
    db.createObjectStore("imagenes", { keyPath: "id", autoIncrement: true });
  }
};
request.onsuccess = e => { db = e.target.result; };
request.onerror = e => { console.error("IndexedDB error", e); };

// --- Funciones carrusel ---
function organizarCirculo() {
  const total = images.length;
  const radius = 200;
  images.forEach((img,i)=>{
    const angle = (i/total)*2*Math.PI + rotation;
    const x = radius*Math.cos(angle) + container.offsetWidth/2 - img.offsetWidth/2;
    const y = radius*Math.sin(angle) + container.offsetHeight/2 - img.offsetHeight/2;
    img.style.left = `${x}px`;
    img.style.top = `${y}px`;
    const normalizedAngle = (angle % (2*Math.PI) + 2*Math.PI) % (2*Math.PI);
    img.style.zIndex = Math.floor(Math.cos(normalizedAngle)*10)+10;
  });
}

function agregarImagen(src, id=null) {
  const img = document.createElement('img');
  img.src = src;
  img.dataset.id = id;
  img.loading="lazy";
  img.addEventListener('mouseenter',()=>isPaused=true);
  img.addEventListener('mouseleave',()=>isPaused=false);

  container.appendChild(img);
  images.push(img);
  organizarCirculo();

  // franja
  const thumbContainer = document.createElement('div');
  thumbContainer.className='thumb-container';
  const thumb = document.createElement('img');
  thumb.src=src;
  thumb.addEventListener('click',()=>{
    const idx = images.findIndex(i=>i.dataset.id==id);
    if(idx>=0){ rotation=-(idx/images.length)*2*Math.PI; organizarCirculo(); }
  });
  const btnEliminar = document.createElement('button');
  btnEliminar.className='btnEliminar';
  btnEliminar.textContent='×';
  btnEliminar.onclick=(e)=>{
    e.stopPropagation();
    const idx = images.findIndex(i=>i.dataset.id==id);
    if(idx>=0){ const imgToRemove=images.splice(idx,1)[0]; container.removeChild(imgToRemove); eliminarImagenDB(id); }
    franja.removeChild(thumbContainer);
  };
  thumbContainer.appendChild(thumb);
  thumbContainer.appendChild(btnEliminar);
  franja.appendChild(thumbContainer);
}

// --- DB ---
function guardarImagenDB(src) {
  const transaction = db.transaction(["imagenes"],"readwrite");
  transaction.objectStore("imagenes").add({src});
}
function cargarDesdeDB() {
  const transaction = db.transaction(["imagenes"],"readonly");
  const store = transaction.objectStore("imagenes");
  const request = store.getAll();
  request.onsuccess = ()=>{ request.result.forEach(item=>agregarImagen(item.src,item.id)); };
}
function eliminarImagenDB(id) {
  const transaction = db.transaction(["imagenes"],"readwrite");
  transaction.objectStore("imagenes").delete(id);
}

// --- Animación ---
container.addEventListener('wheel', e=>{ e.preventDefault(); speed += e.deltaY*-0.0005; });
function animar() {
  if(!isPaused){
    rotation += speed;
    const cycles = Math.floor(rotation/(2*Math.PI));
    if(cycles>lastCycle){ lastCycle=cycles; if(images.length>1){ const first=images.shift(); images.push(first); } }
  }
  organizarCirculo();
  requestAnimationFrame(animar);
}
animar();

// --- Demo / Select ---
btnDemo.addEventListener('click', ()=>{
  menuInicial.style.display='none';
  container.style.display='block';
  franja.style.display='flex';
  cargarURLs();
  cargarDesdeDB();
});
btnSelect.addEventListener('click', ()=>{
  menuInicial.style.display='none';
  container.style.display='block';
  franja.style.display='flex';
  inputFiles.click();
  cargarDesdeDB();
});

inputFiles.addEventListener('change', e=>{
  for(let file of e.target.files){
    const reader = new FileReader();
    reader.onload=()=>{ agregarImagen(reader.result); guardarImagenDB(reader.result); };
    reader.readAsDataURL(file);
  }
});

// --- Vaciar ---
btnVaciar.addEventListener('click', ()=>{
  images.forEach(img=>container.removeChild(img));
  images=[]; franja.innerHTML='';
  const transaction=db.transaction(["imagenes"],"readwrite");
  transaction.objectStore("imagenes").clear();
  rotation=0; speed=0.01;
});

// --- Cargar URLs externas ---
function cargarURLs() {
  const urls = [
    {titulo:"5 electrodomésticos",src:"https://www.kissu.com.ec/imagenes//subcategorias/1659549117.jpg"},
    {titulo:"6 cocina",src:"https://www.kissu.com.ec/imagenes//productos/sm/17081008480.jpg"},
    {titulo:"7 tanque",src:"https://www.kissu.com.ec/imagenes//productos/sm/16789070110.jpg"},
    {titulo:"8 valvula gas",src:"https://www.kissu.com.ec/imagenes//productos/sm/17477744290.jpg"}
  ];
  urls.forEach(item=>agregarImagen(item.src,item.titulo));
}
</script>
</body>
</html>